name: CI      
on:
  push:
    branches:
    - master
    - develop
    - release/*
jobs:
  setup:
    runs-on: macOS-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Carthage
        run: |
          set -o pipefail && carthage update --platform iOS --no-use-binaries
      - name: Scanner
        run: |  
          export SONAR_SCANNER_VERSION=4.0.0.1744
          export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-macosx
          rm -rf $SONAR_SCANNER_HOME
          mkdir -p $SONAR_SCANNER_HOME
          curl -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-macosx.zip
          unzip $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          rm $HOME/.sonar/sonar-scanner.zip
          export PATH=$SONAR_SCANNER_HOME/bin:$PATH
          export SONAR_SCANNER_OPTS="-server" 
  test:
    needs: setup
    runs-on: macOS-latest
    strategy:
        matrix:
          destination: ['platform=iOS Simulator,OS=12.4,name=iPhone XR']
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Clean, Build and Test
        env: 
         CODECOV_TOKEN: "ff30730f-ba71-4122-a5c8-faf3dbcdfa57"
         destination: ${{ matrix.destination }}
        run: |
          set -o pipefail && xcodebuild clean build test -project Skeleton.xcodeproj -scheme Skeleton -destination "${destination}" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO ONLY_ACTIVE_ARCH=NO | xcpretty
          curl -s https://codecov.io/bash -J 'Skeleton' -t $CODECOV_TOKEN | bash
  scanner:
    needs: [setup, test]
    runs-on: macOS-latest
    steps:
      - name: Sonar Scanner
        run: |
          sonar-scanner \
            -Dsonar.projectKey=lucabelezal_Skeleton \
            -Dsonar.organization=skeleton \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=6f2f5950b1a412d55a3c3c4841ada5ce941407d4
